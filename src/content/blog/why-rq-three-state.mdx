---
title: 'React Query를 사용하는 이유와 서버 데이터를 구분하는 방법'
description: 'React Query는 왜 사용하는걸까요? 그리고 React Query는 서버의 데이터를 어떻게 구분할까요?'
pubDate: '2024-01-10'
heroImage: 'public/blog/hero-image/why-rq-three-state.png'
category: '프론트엔드'
tags: ['react-query']
---

## React Query를 사용하는 이유와 서버 데이터의 구분 기준

React Query가 나오기 이전에 Server State를 관리한다고 하면, 작은 프로젝트는 Fetching해온 데이터를 Redux 등의 전역 상태 관리 라이브러리를 통해 필요한 컴포넌트가 가져다 쓰도록 하는 방식이 주를 이뤘다.

그런데 애초에 그 라이브러리들이 '전역 상태 관리' 라이브러리이지, '서버 상태 관리'를 위해 만들어진 것이 아니었다보니, 여러 곳에서 비효율성이 드러나기 시작했다. Redux의 경우, 원래 라이브러리 철학 자체가 전역 상태를 '직접' 변경하는 것을 허용하지 않다보니 mutation이 필요한 상태마다 리듀서 생성이 불가피하고, 그로 인한 전체적인 Store의 크기도 비대해지는 문제가 있었다. 특히, 서버 리소스 절약 및 UX 향상을 위한 캐싱 도입 시에도 전역 상태 관리 라이브러리는 복잡한 설정들이 많이 추가돼야했다고 한다.

하지만 React Query는 Provider의 영역 내에서 서버에서 불러온 데이터를 상태로서 공유할 수 있고, 서버의 데이터와 이미 캐싱된 데이터의 변경사항을 감지할 수 있고, Redux 시절에 일일이 구현해야했던 반환값들(data, isLoading, error, ...)을 훅으로 간단하게 제공해준다. Server State를 관리하는 데 매우 최적화된 도구라고 할 수 있다.

같은 목적을 위해 태어난 Vercel의 SWR(공식문서: Stail-While-Revalidate 전략에서 유래)이라는 도구도 있다.

React Query에서는 Server State의 상태(status)를 Fresh, Fetching, Paused, Stale, Inactive의 5가지로 구분한다. 이 각각의 상태는 어떤 의미를 갖는지 알아보자.

- Fresh: 이제 막 서버에서 불러온 데이터(응답 값). staleTime동안 Fresh 상태가 유지된다.
- Stale: 서버에 있는 데이터와 차이가 있을 수도 있는 데이터(최신화 필요)
- Fetching: 서버에서 가져오고 있는 데이터(로딩 중)
- Paused: Fetching이 중단된 상태(네트워크 연결 끊김 등에 의해)
- Inactive: 캐싱되었지만 현재 페이지에서 사용되고 있지 않은 데이터

핵심은 Fresh와 Stale이다. 모든 서버 데이터는 Fresh -> Stale이 되는데, Fresh 상태의 데이터는 새로고침 시에도 캐싱된 상태에서 불러와지기 때문에 네트워크 요청이 발생하지 않는데, staleTime 이후에는 Stale 상태가 되어 새로고침 또는 Window Focus, 컴포넌트 Mount 등에 의해 서버에서 새로운 데이터를 불러오게 된다.

이 staleTime은 기본값이 0으로 설정되어 있으며, queryClient 또는 queryOption으로 설정해줄 수 있다.

gcTime도 있는데, 이건 **g**arbage **c**ollection **Time** 즉, Inactive 상태의 data가 gc에 의해 정리되는 주기를 설정하는 옵션이다.
무조건 staleTime보다는 길게 설정해줘야한다. 왜냐면 staleTime보다 gcTime이 짧게 설정될 경우, staleTime 주기가 돌아오기 전에 잠깐 Inactive 상태가 되었던 데이터가 gc에 의해 삭제돼서 의도한 staleTime동안 데이터가 캐싱되지 않을 수도 있기 때문이다.

## refetch, invalidate, reset의 차이

React Query Devtools에 보면 특정 queryData에 대해 실행할 수 있는 Refetch, Invalidate, Reset 등의 Action이 있다. 이들 Action의 기능이 무엇인지 알아보자.

- Refetch: 해당 데이터를 네트워크 요청을 통해 새로 받아온다.
- Invalidate: 해당 데이터를 '새로 받아와야하는 상태'로 만든다. Inactive 상태일 때는 네트워크 요청을 하지 않다가 컴포넌트 Mount 등에 의해 해당 데이터를 사용하는 Observer가 1 이상 존재하게 되면 그 때 네트워크 요청을 통해 새로운 데이터를 불러온다.
- Reset: reset은 queryOptions에 initialState를 설정한 경우 queryData를 initialData로 초기화하고, 따로 설정값이 없으면 네트워크 요청을 통해 데이터를 불러온다.
- Remove: 해당 데이터를 제거한다.
- Trigger Loading / Restore Loading: 해당 데이터를 로딩 상태로 만들거나 복구시킨다.
- Trigger Error / Restore Error: 해당 데이터를 불러오지 못한 상태로 만들거나 복구시킨다.
